diff --git a/api/core/file/upload_file_parser.py b/api/core/file/upload_file_parser.py
new file mode 100644
index 0000000000..96b2884811
--- /dev/null
+++ b/api/core/file/upload_file_parser.py
@@ -0,0 +1,67 @@
+import base64
+import logging
+import time
+from typing import Optional
+
+from configs import dify_config
+from constants import IMAGE_EXTENSIONS
+from core.helper.url_signer import UrlSigner
+from extensions.ext_storage import storage
+
+
+class UploadFileParser:
+    @classmethod
+    def get_image_data(cls, upload_file, force_url: bool = False) -> Optional[str]:
+        if not upload_file:
+            return None
+
+        if upload_file.extension not in IMAGE_EXTENSIONS:
+            return None
+
+        if dify_config.MULTIMODAL_SEND_FORMAT == "url" or force_url:
+            return cls.get_signed_temp_image_url(upload_file.id)
+        else:
+            # get image file base64
+            try:
+                data = storage.load(upload_file.key)
+            except FileNotFoundError:
+                logging.exception(f"File not found: {upload_file.key}")
+                return None
+
+            encoded_string = base64.b64encode(data).decode("utf-8")
+            return f"data:{upload_file.mime_type};base64,{encoded_string}"
+
+    @classmethod
+    def get_signed_temp_image_url(cls, upload_file_id) -> str:
+        """
+        get signed url from upload file
+
+        :param upload_file_id: the id of UploadFile object
+        :return:
+        """
+        base_url = dify_config.FILES_URL
+        image_preview_url = f"{base_url}/files/{upload_file_id}/image-preview"
+
+        return UrlSigner.get_signed_url(url=image_preview_url, sign_key=upload_file_id, prefix="image-preview")
+
+    @classmethod
+    def verify_image_file_signature(cls, upload_file_id: str, timestamp: str, nonce: str, sign: str) -> bool:
+        """
+        verify signature
+
+        :param upload_file_id: file id
+        :param timestamp: timestamp
+        :param nonce: nonce
+        :param sign: signature
+        :return:
+        """
+        result = UrlSigner.verify(
+            sign_key=upload_file_id, timestamp=timestamp, nonce=nonce, sign=sign, prefix="image-preview"
+        )
+
+        # verify signature
+        if not result:
+            return False
+
+        current_time = int(time.time())
+        return current_time - int(timestamp) <= dify_config.FILES_ACCESS_TIMEOUT
diff --git a/api/core/indexing_runner.py b/api/core/indexing_runner.py
index 305a9190d5..a64f19e9d0 100644
--- a/api/core/indexing_runner.py
+++ b/api/core/indexing_runner.py
@@ -320,7 +320,8 @@ class IndexingRunner:
                     if image_file is None:
                         continue
                     try:
-                        storage.delete(image_file.key)
+                        if image_file:
+                            storage.delete(image_file.key)
                     except Exception:
                         logging.exception(
                             "Delete image_files failed while indexing_estimate, \
diff --git a/api/core/tools/tool_manager.py b/api/core/tools/tool_manager.py
index adae56cd27..7ff1844bd8 100644
--- a/api/core/tools/tool_manager.py
+++ b/api/core/tools/tool_manager.py
@@ -354,7 +354,6 @@ class ToolManager:
         """
         get the workflow tool runtime
         """
-
         tool_runtime = cls.get_tool_runtime(
             provider_type=workflow_tool.provider_type,
             provider_id=workflow_tool.provider_id,
